# API Gateway Development Process - Step by Step

---

## PHASE 1: ROUTING & CONFIGURATION

### 1. Configuration Management

**Thá»© Tá»± Implementation:**
```
1. Táº¡o configuration trong application.yml â†’ "app.routes"
2. Táº¡o Config classes Ä‘á»ƒ Ä‘á»c properties tá»« YAML
3. Implement Repository Ä‘á»ƒ load vÃ  quáº£n lÃ½ config
```

**Kiáº¿n TrÃºc File Structure:**

```
ğŸ“ Cáº¥u trÃºc file Ä‘á»ƒ quáº£n lÃ½ configuration nhÆ° database:

1ï¸âƒ£ Entity Layer (/entity): Äá»‹nh nghÄ©a data model (object structure)
2ï¸âƒ£ Config Layer (/data/config): Load data tá»« application.yml
3ï¸âƒ£ Repository Interface (/interfaces)
   â””â”€ Äá»‹nh nghÄ©a contract cho data access
   â””â”€ Má»¥c Ä‘Ã­ch: Dá»… dÃ ng chuyá»ƒn Ä‘á»•i tá»« file config â†’ database
4ï¸âƒ£ Repository Implementation (/repository): Implement interface vá»›i concrete logic
5ï¸âƒ£ Service Layer (/service)
   â””â”€ Business logic vÃ  data manipulation
   â””â”€ Query, filter, transform data
```

**Benefits cá»§a kiáº¿n trÃºc nÃ y:**
- Dá»… dÃ ng chuyá»ƒn Ä‘á»•i tá»« YAML config â†’ Database
- Code khÃ´ng cáº§n thay Ä‘á»•i khi Ä‘á»•i data source
- TuÃ¢n thá»§ SOLID principles (Dependency Inversion)
---

### 2. Route Registration

**Startup Flow:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Application Startup                              â”‚
â”‚    â””â”€ Spring Boot initializes beans                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2. GatewayStartupLoader                             â”‚
â”‚    â””â”€ Load configuration from YAML/Database         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3. Load Services Configuration                      â”‚
â”‚    â””â”€ Service.loadAll()                             â”‚
â”‚    â””â”€ Parse service definitions                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 4. Register Routes Dynamically                      â”‚
â”‚    â””â”€ RouteLocator.routes() for each service        â”‚
â”‚    â””â”€ Apply filters to each route                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 5. Gateway Ready                                    â”‚
â”‚    â””â”€ Accept incoming requests                      â”‚
â”‚    â””â”€ Route to appropriate services                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## PHASE 2: FILTER IMPLEMENTATION

### Filter Chain Overview

```
Request Flow:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client Request                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     |
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   IP block filter     â”‚ Orders: -30
         â”‚    (blacklist)        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     |
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   Rate Limit Filter   â”‚ Order: -25
         â”‚   (DDoS protection)   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Validation Filter     â”‚ Order: -20 âœ…
         â”‚ (Headers, Body, etc)  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Authentication        â”‚ Order: 0 âœ…
         â”‚ (JWT Validation)      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Authorization         â”‚ Order: 1
         â”‚ (Permission Check)    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Rate Limit (Account)  â”‚ Order: 10
         â”‚ (User Quota)          â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   Another filter      â”‚ 
         â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     |
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Backend Service       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Filter 1: Validation Filter (Order: -20)

**ğŸ¯ Nhiá»‡m Vá»¥:**
```
âœ… Kiá»ƒm tra endpoint cÃ³ tá»“n táº¡i khÃ´ng (path + method)
âœ… Validate method requirements:
   â€¢ POST/PUT/PATCH: Require body (check exists + size), Content-Type
   â€¢ GET/DELETE: Validate query params (check exists + size)
âœ… Kiá»ƒm tra required headers cá»§a tá»«ng endpoint
âœ… Validate header values (allowed headers from endpoint only)
âœ… Kiá»ƒm tra max length cá»§a header values
âœ… Block requests tá»« blocked domains
```

---

### Filter 2: Authentication Filter (Order: 0)

**ğŸ¯ Nhiá»‡m Vá»¥:**
```
âœ… PhÃ¢n biá»‡t endpoint: Public vs Protected
âœ… Public endpoint:
   â€¢ Skip JWT validation
   â€¢ Add API key vÃ o headers
   â€¢ Forward to next filter
âœ… Protected endpoint:
   â€¢ Validate JWT token (signature, expiration)
   â€¢ Extract user info (userId, email, roles)
   â€¢ Add user context vÃ o request headers
   â€¢ Add API key vÃ o headers
   â€¢ Forward to next filter
```

**ğŸ” Authentication Flow:**
```
Request with JWT Token
    â”‚
    â”œâ”€â†’ Check endpoint type
    â”‚   â”œâ”€â†’ Public? â†’ Skip validation â†’ Add API key â†’ Next filter
    â”‚   â””â”€â†’ Protected? â†’ Continue validation
    â”‚
    â”œâ”€â†’ Extract JWT from Authorization header
    â”‚   â””â”€â†’ Format: "Bearer <token>"
    â”‚
    â”œâ”€â†’ Validate JWT
    â”‚   â”œâ”€â†’ Verify signature (secret key)
    â”‚   â”œâ”€â†’ Check expiration time
    â”‚   â””â”€â†’ Validate issuer & audience
    â”‚
    â”œâ”€â†’ Extract user info from JWT claims
    â”‚   â”œâ”€â†’ userId (subject)
    â”‚   â”œâ”€â†’ email
    â”‚   â””â”€â†’ roles/permissions
    â”‚
    â””â”€â†’ Add to request headers
        â”œâ”€â†’ X-User-Id: {userId}
        â”œâ”€â†’ X-User-Email: {email}
        â”œâ”€â†’ X-User-Roles: {roles}
        â””â”€â†’ X-API-Key: {internalApiKey}

```
---

### Filter 3: Authorization Filter (Order: 1)

**ğŸ¯ Nhiá»‡m Vá»¥:**
```
âœ… Láº¥y user info tá»« request headers
âœ… Kiá»ƒm tra endpoint cÃ³ require permissions khÃ´ng
âœ… Validate user roles/permissions vá»›i required permissions
âœ… Allow hoáº·c deny access dá»±a trÃªn permission check
```

**ğŸ”‘ Authorization Logic:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Get User Info from Headers                  â”‚
â”‚ â€¢ X-User-Id                                 â”‚
â”‚ â€¢ X-User-Roles                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Get Endpoint Required Permissions           â”‚
â”‚ â€¢ Read from endpoint configuration          â”‚
â”‚ â€¢ Example: ["USER", "ADMIN"]                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Check User Has Required Permission          â”‚
â”‚ â€¢ User roles âˆ© Required roles = Ã¸? â†’ Deny   â”‚
â”‚ â€¢ User roles âˆ© Required roles â‰  Ã¸? â†’ Allow  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                   â”‚
    Allow Access        Deny Access
         â”‚                   â”‚
    Next Filter         403 Forbidden
```

**ğŸ‘¥ Role Hierarchy Example:**
```
ADMIN > MANAGER > USER > GUEST

â€¢ ADMIN: Full access to all endpoints
â€¢ MANAGER: Access to management endpoints + user endpoints
â€¢ USER: Access to user-specific endpoints
â€¢ GUEST: Access to public endpoints only
```
---

### Filter 4: Rate Limiting Filter (Dual Implementation)

**ğŸ¯ Nhiá»‡m Vá»¥:**
```
âœ… Kiá»ƒm tra sá»‘ lÆ°á»£ng token cÃ²n láº¡i (remaining quota)
âœ… Cho phÃ©p request tiáº¿p tá»¥c náº¿u cÃ²n token available
âœ… Tá»« chá»‘i request náº¿u vÆ°á»£t quÃ¡ giá»›i háº¡n â†’ 429 Too Many Requests
âœ… Há»— trá»£ rate limiting theo IP (public endpoints)
âœ… Há»— trá»£ rate limiting theo Account ID (protected endpoints)
```

**ğŸ“Š Chiáº¿n LÆ°á»£c Rate Limiting:**

|  | **Strategy 1: IP-Based** | **Strategy 2: Account-Based** |
|---|---|---|
| **Order** | -10 | 10 |
| **Vá»‹ trÃ­** | TrÆ°á»›c Authentication Filter | Sau Authentication Filter |
| **Má»¥c tiÃªu** | All Public endpoints | Protected endpoints |
| **Má»¥c Ä‘Ã­ch** | Chá»‘ng DDoS | Giá»›i háº¡n usage per user/account (quota management) |
| **Cache Key** | `rate_limit:ip:{IP_ADDRESS}` | `rate_limit:account:{ACCOUNT_ID}` |

**Use Cases:**
- API usage quotas per subscription tier
- Prevent single user from overloading system
- Fair resource distribution among users

---

### ğŸª£ Thuáº­t ToÃ¡n: Token Bucket vá»›i Redis

**Token Bucket Components:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Token Bucket                        â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ğŸª™ ğŸª™ ğŸª™ ğŸª™ ğŸª™ ğŸª™ ğŸª™ ğŸª™ ğŸª™ ğŸª™                 â”‚    â”‚
â”‚  â”‚        Available Tokens                     â”‚    â”‚
â”‚  â”‚  Capacity: 100 tokens (Burst Capacity)      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                     â”‚
â”‚  âš™ï¸  Refiller: 10 tokens/second (Replenish Rate)    â”‚
â”‚  ğŸ“¥  Request Cost: -1 token per request             â”‚
â”‚  â±ï¸  Auto-refill: Every second                      â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Concepts:**
- **Burst Capacity**: Maximum tokens trong bucket (há»— trá»£ traffic spikes)
- **Replenish Rate**: Tá»‘c Ä‘á»™ náº¡p token (vÃ­ dá»¥: 10 tokens/giÃ¢y)
- **Token Cost**: Má»—i request tiÃªu thá»¥ 1 token

---

### âš™ï¸ CÃ¡ch Hoáº¡t Äá»™ng Chi Tiáº¿t

#### **1. Token Refill (Auto Background Process)**
**Rules:**
- âœ… Tá»± Ä‘á»™ng refill má»—i giÃ¢y theo Replenish Rate
- âœ… Sá»‘ lÆ°á»£ng token khÃ´ng vÆ°á»£t quÃ¡ Burst Capacity
- âœ… Token trÃ n ra sáº½ bá»‹ loáº¡i bá»

#### **2. Request Processing Logic**
```java
    // Pseudo-code for rate limiting check
    function handleRequest(key):
        bucket = redis.get(key)
        
        if (bucket == null):
            // First request - initialize bucket
            bucket = {
                tokens: burstCapacity,
                lastRefill: now(),
                capacity: burstCapacity,
                rate: replenishRate
            }
        
        // Calculate tokens to add since last refill
        timeElapsed = now() - bucket.lastRefill
        tokensToAdd = timeElapsed * bucket.rate
        bucket.tokens = min(bucket.tokens + tokensToAdd, bucket.capacity)
        bucket.lastRefill = now()
        
        // Check if request can proceed
        if (bucket.tokens >= 1):
            bucket.tokens -= 1
            redis.set(key, bucket, TTL)
            return ALLOW  // âœ… Pass to next filter
        else:
            redis.set(key, bucket, TTL)
            return REJECT  // âŒ 429 Too Many Requests
```

#### **3. Redis Cache Strategy**

**IP-Based Cache (Public Endpoints):**
```java
    Key Pattern: rate_limit_ip:{IP_ADDRESS}
    Value: {
        "tokens": 95,
        "lastRefill": 1738483200,
        "burstCapacity": 100,
        "replenishRate": 10
    }
    TTL: 3600 seconds (1 hour)

    Example Keys:
    - rate_limit:ip:192.168.1.100
    - rate_limit:ip:203.0.113.45
```

**Account-Based Cache (Protected Endpoints):**
```java
    Key Pattern: rate_limit:account:{ACCOUNT_ID}
    Value: {
        "tokens": 850,
        "lastRefill": 1738483200,
        "burstCapacity": 1000,
        "replenishRate": 50
    }
    TTL: 3600 seconds (1 hour)

    Example Keys:
    - rate_limit:account:user_12345
    - rate_limit:account:acc_67890
```
---

### ğŸ“ˆ Rate Limiting Scenarios

**Scenario 1: Normal Traffic**
```java
    Time: 0s  â†’ Request 1 â†’ 100 tokens â†’ Allow (99 tokens left)
    Time: 0s  â†’ Request 2 â†’ 99 tokens  â†’ Allow (98 tokens left)
    Time: 1s  â†’ Refill    â†’ 108 tokens (98 + 10, capped at 100)
    Time: 1s  â†’ Request 3 â†’ 100 tokens â†’ Allow (99 tokens left)
```

**Scenario 2: Burst Traffic**
```java
    Time: 0s  â†’ 100 requests in 1 second
              â†’ Token depleted from 100 to 0
              â†’ All 100 requests allowed
    Time: 1s  â†’ Request 101     â†’ 0 tokens â†’ REJECT (429)
    Time: 1s  â†’ Refill          â†’ 10 tokens
    Time: 1s  â†’ Request 102-111 â†’ Allow (10 requests)
    Time: 2s  â†’ Request 112     â†’ 0 tokens â†’ REJECT (429)
```

**Scenario 3: DDoS Attack**
```java
    Attacker IP: 203.0.113.666
    Time: 0s  â†’ 1000 requests/second
              â†’ First 100 allowed (burst capacity)
              â†’ Remaining 900 rejected (429 Too Many Requests)
              â†’ Attacker blocked effectively
              â†’ Push "IP address" into blacklist for waiting
```

---

## PHASE 3: MONITORING & OBSERVABILITY

### ğŸ“Š 1. Metrics (Micrometer + Prometheus)

**Äá»‹nh NghÄ©a:**
```
Metrics lÃ  cÃ¡c thÃ´ng sá»‘ Ä‘o lÆ°á»ng hiá»‡u suáº¥t há»‡ thá»‘ng Ä‘Æ°á»£c thu tháº­p liÃªn tá»¥c
vÃ  hiá»ƒn thá»‹ dÆ°á»›i dáº¡ng biá»ƒu Ä‘á»“ (time-series data) Ä‘á»ƒ phÃ¢n tÃ­ch xu hÆ°á»›ng.
```

**ğŸ› ï¸ TechStack:**

| **Component** | **Technology** | **Vai trÃ²** | **Port** |
|---------------|----------------|-------------|----------|
| **Exposer** | Spring Boot Actuator + Micrometer | Expose metrics endpoints tá»« á»©ng dá»¥ng Spring Boot | `/actuator/prometheus` |
| **Collector** | Prometheus | Thu tháº­p (scrape) metrics tá»« cÃ¡c service theo interval | Default: 9090 |
| **Visualization** | Grafana | Táº¡o dashboard, biá»ƒu Ä‘á»“ trá»±c quan tá»« dá»¯ liá»‡u Prometheus | Default: 3000 |
| **Tracing** | Zipkin / Jaeger | Distributed tracing - theo dÃµi request qua nhiá»u service | Zipkin: 9411<br>Jaeger: 16686 |

**ğŸ“Š Luá»“ng Hoáº¡t Äá»™ng:**

```
    Spring Boot App (Micrometer) 
        â†“ expose metrics
    `/actuator/prometheus` endpoint
        â†“ scrape every 15s
    Prometheus Server (Time-series DB)
        â†“ query data
    Grafana Dashboard (Visualization)
        â†“ display
    Beautiful Charts & Alerts
```

#### **CÃ¡c Loáº¡i Metrics:**

##### **Counter (Bá»™ Äáº¿m TÄƒng Dáº§n)**
```
    Äáº·c Ä‘iá»ƒm:
    â€¢ Chá»‰ tÄƒng, khÃ´ng giáº£m
    â€¢ Reset vá» 0 khi restart service
    â€¢ DÃ¹ng Ä‘á»ƒ Ä‘áº¿m sá»‘ lÆ°á»£ng events(requests)

    Use Cases:
    âœ… Total requests count
    âœ… Total errors count
    âœ… Total successful authentication
```

##### **Gauge (GiÃ¡ Trá»‹ Táº¡i Thá»i Äiá»ƒm)**
```
    Äáº·c Ä‘iá»ƒm:
    â€¢ CÃ³ thá»ƒ tÄƒng hoáº·c giáº£m
    â€¢ Äo giÃ¡ trá»‹ hiá»‡n táº¡i táº¡i thá»i Ä‘iá»ƒm query
    â€¢ Snapshot cá»§a resource

    Use Cases:
    âœ… Current CPU usage (%)
    âœ… Current memory usage (MB)
    âœ… Active connections count
    âœ… Current thread pool size
    âœ… Redis connection pool availability
```

##### **Histogram (PhÃ¢n Bá»‘ Dá»¯ Liá»‡u)**
```
    Äáº·c Ä‘iá»ƒm:
    â€¢ Äo phÃ¢n bá»‘ giÃ¡ trá»‹ trong nhiá»u buckets
    â€¢ TÃ­nh percentiles
    â€¢ Hiá»ƒu Ä‘Æ°á»£c distribution pattern

    Use Cases:
    âœ… Request duration distribution
    âœ… Response size distribution
    âœ… Token bucket refill latency
```

---

### ğŸ“ 2. Logging (Structured Logging with Logback)

**Äá»‹nh NghÄ©a:**
```
    Logging lÃ  viá»‡c ghi láº¡i chi tiáº¿t events vÃ  errors trong application
    dÆ°á»›i dáº¡ng text/JSON Ä‘á»ƒ debug, audit vÃ  troubleshooting.
```

---

### ğŸ“‹ Logging Strategy

#### **1. Access Logs (Request/Response Logs)**
```
    Má»¥c Ä‘Ã­ch: Theo AI truy cáº­p CÃI GÃŒ vÃ  KHI NÃ€O
    Cáº¥u trÃºc: Cáº¥u trÃºc JSON/text dá»… Ä‘á»c
```

**Access Log Fields:**
```json
{
  "timestamp": "2026-02-02T10:30:45.123Z",
  "traceId": "abc123def456",
  "clientIp": "192.168.1.100",
  "method": "GET",
  "path": "/api/users/123",
  "queryParams": "?page=1&limit=10",
  "requestHeaders": {
    "User-Agent": "Mozilla/5.0...",
    "Authorization": "Bearer ***"  // Masked
  },
  "statusCode": 200,
  "responseTime": 145,  // milliseconds
  "responseSize": 2048, // bytes
  "userId": "user_12345",
  "endpoint": "user-service",
  "filterChain": ["validation", "auth", "authz"],
  "rateLimitStatus": "allowed"
}
```

---

#### **2. Application Logs (Business Logic & Errors)**
```
    Má»¥c Ä‘Ã­ch: theo dÃµi hÃ nh Ä‘á»™ng, lá»—i, thÃ´ng tin debug cá»§a application
    Cáº¥u trÃºc: Cáº¥u trÃºc theo context
```

---

### ğŸ” 3. Distributed Tracing (Spring Cloud Sleuth + Zipkin)

**Äá»‹nh NghÄ©a:**
```
      Tracing lÃ  viá»‡c theo dÃµi má»™t request Ä‘i qua nhiá»u services (microservices) 
    Ä‘á»ƒ hiá»ƒu Ä‘Æ°á»£c flow, identify bottlenecks vÃ  debug distributed systems.
```

#### **Key Concepts:**

##### **Trace**
```
    Represents toÃ n bá»™ journey cá»§a 1 request qua nhiá»u services
    Má»—i trace cÃ³ unique Trace ID
```

##### **Span**
```
    Represents 1 Ä‘oáº¡n cÃ´ng viá»‡c trong trace (1 operation)
    Má»—i span cÃ³ unique Span ID vÃ  thuá»™c vá» 1 Trace ID
```

**Example Trace Flow:**
```
Client Request
    â”‚
    â”œâ”€ Trace ID: abc-123-def
    â”‚
    â”œâ”€ Span 1: API Gateway (Validation Filter)
    â”‚  â””â”€ Duration: 5ms
    â”‚
    â”œâ”€ Span 2: API Gateway (Authentication Filter)
    â”‚  â””â”€ Duration: 20ms (JWT validation)
    â”‚
    â”œâ”€ Span 3: API Gateway (Authorization Filter)
    â”‚  â””â”€ Duration: 3ms
    â”‚
    â”œâ”€ Span 4: API Gateway â†’ User Service
    â”‚  â””â”€ Duration: 150ms
    â”‚     â”‚
    â”‚     â”œâ”€ Span 4.1: User Service (Business Logic)
    â”‚     â”‚  â””â”€ Duration: 50ms
    â”‚     â”‚
    â”‚     â””â”€ Span 4.2: User Service â†’ Database Query
    â”‚        â””â”€ Duration: 100ms
    â”‚
    â””â”€ Total Duration: 178ms
```

---

## PHASE 4: LOAD BALANCING 

#### **âŒ Circuit Breaker**

#### **ğŸ¯ Má»¥c Ä‘Ã­ch**

| **Äáº·c tÃ­nh** | **MÃ´ táº£** |
|--------------|-----------|
| **High Availability** | Náº¿u má»™t instance bá»‹ sáº­p (crash), há»‡ thá»‘ng váº«n hoáº¡t Ä‘á»™ng nhá» cÃ¡c instance cÃ²n láº¡i |
| **Scalability** | Khi lÆ°á»£ng user tÄƒng vá»t, báº¡n báº­t thÃªm instance má»›i Ä‘á»ƒ chá»‹u táº£i |

---

#### **âš™ï¸ CÃ¡c Thuáº­t ToÃ¡n Phá»• Biáº¿n**

| **Thuáº­t toÃ¡n** | **CÆ¡ cháº¿** | **Æ¯u Ä‘iá»ƒm** | **NhÆ°á»£c Ä‘iá»ƒm / PhÃ¹ há»£p** |
|----------------|------------|-------------|--------------------------|
| **Round Robin**<br>(VÃ²ng trÃ²n) | Gateway phÃ¢n phá»‘i láº§n lÆ°á»£t theo thá»© tá»±:<br>Request 1 â†’ Instance A<br>Request 2 â†’ Instance B<br>Request 3 â†’ Instance C<br>Request 4 â†’ quay láº¡i Instance A | âœ… ÄÆ¡n giáº£n, dá»… cÃ i Ä‘áº·t | âŒ KhÃ´ng quan tÃ¢m Ä‘áº¿n tÃ¬nh tráº¡ng sá»©c khá»e cá»§a server<br>(Instance A Ä‘ang cháº­m váº«n bá»‹ dÃ­ request) |
| **Weighted Round Robin**<br>(VÃ²ng trÃ²n cÃ³ trá»ng sá»‘) | TÆ°Æ¡ng tá»± Round Robin, nhÆ°ng gÃ¡n "Ä‘iá»ƒm sá»‘" cho server.<br>Server máº¡nh hÆ¡n (RAM/CPU cao) nháº­n trá»ng sá»‘ cao hÆ¡n | âœ… Tá»‘i Æ°u cho háº¡ táº§ng khÃ´ng Ä‘á»“ng nháº¥t | ğŸ¯ PhÃ¹ há»£p: Khi cÃ³ mÃ¡y máº¡nh, mÃ¡y yáº¿u |
| **Least Connections**<br>(Ãt káº¿t ná»‘i nháº¥t) | Gateway kiá»ƒm tra instance nÃ o Ä‘ang xá»­ lÃ½ Ã­t request nháº¥t vÃ  Ä‘áº©y request má»›i vÃ o Ä‘Ã³ | âœ… Tá»‘i Æ°u cho request cÃ³ thá»i gian xá»­ lÃ½ khÃ´ng Ä‘á»u<br>âœ… TrÃ¡nh server bá»‹ quÃ¡ táº£i | ğŸ¯ PhÃ¹ há»£p: Request cÃ³ Ä‘á»™ phá»©c táº¡p khÃ¡c nhau |
| **IP Hash**<br>(Sticky Session) | DÃ¹ng IP cá»§a client Ä‘á»ƒ tÃ­nh toÃ¡n.<br>CÃ¹ng má»™t IP luÃ´n Ä‘Æ°á»£c Ä‘iá»u hÆ°á»›ng vá» Ä‘Ãºng má»™t instance cá»‘ Ä‘á»‹nh | âœ… Giá»¯ Ä‘Æ°á»£c session cá»¥c bá»™ | ğŸ¯ PhÃ¹ há»£p: á»¨ng dá»¥ng cáº§n lÆ°u tráº¡ng thÃ¡i trÃªn server<br>âš ï¸ Ãt dÃ¹ng vá»›i kiáº¿n trÃºc hiá»‡n Ä‘áº¡i (JWT + Redis) |

---

#### **ğŸ” Káº¿t Há»£p Vá»›i Service Discovery**

```
Backend Service Start â†’ Register IP/Port â†’ Service Registry
                                              â†“
API Gateway Receives Request â†’ Query Registry â†’ Get Active Instances
                                              â†“
                                    Apply Load Balancing Algorithm
                                              â†“
                                    Forward Request to Selected Instance
```

| **BÆ°á»›c** | **MÃ´ táº£** |
|----------|-----------|
| **1. Service Discovery** | Khi Backend khá»Ÿi Ä‘á»™ng, Ä‘Äƒng kÃ½ IP/Port lÃªn Service Registry (danh báº¡ chung) |
| **2. API Gateway Query** | Khi nháº­n request, Gateway há»i "danh báº¡" xem Service A cÃ³ nhá»¯ng instance nÃ o active |
| **3. Load Balancing** | Sau khi cÃ³ danh sÃ¡ch IP, Gateway dÃ¹ng thuáº­t toÃ¡n (VD: Round Robin) Ä‘á»ƒ chá»n IP vÃ  chuyá»ƒn tiáº¿p |

> ğŸ’¡ **LÆ°u Ã½:** Trong Spring Cloud, Spring Cloud Gateway káº¿t há»£p vá»›i **Spring Cloud LoadBalancer** Ä‘á»ƒ thá»±c hiá»‡n tá»± Ä‘á»™ng.

---

#### **ğŸ¥ Health Check**

| **Loáº¡i** | **CÆ¡ cháº¿** | **Má»¥c Ä‘Ã­ch** |
|----------|------------|--------------|
| **Active Health Check** | Gateway Ä‘á»‹nh ká»³ gá»­i tÃ­n hiá»‡u ping Ä‘áº¿n endpoint cá»§a cÃ¡c service | Kiá»ƒm tra proactive xem service cÃ²n sá»‘ng khÃ´ng |
| **Passive Health Check** | Káº¿t há»£p vá»›i Circuit Breaker Ä‘á»ƒ theo dÃµi lá»—i 5xx | Náº¿u service tráº£ vá» lá»—i 5xx liÃªn tá»¥c â†’ táº¡m thá»i ngáº¯t káº¿t ná»‘i vá»›i instance Ä‘Ã³ |