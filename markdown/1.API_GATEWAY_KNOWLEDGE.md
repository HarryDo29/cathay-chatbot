# Cathay OJT - API Gateway Knowledge

## Má»¥c lá»¥c

- [1. API Gateway lÃ  gÃ¬?](#1-api-gateway-lÃ -gÃ¬)
- [2. Cross-cutting Concerns](#2-cross-cutting-concerns)
- [3. CORS (Cross-Origin Resource Sharing)](#3-cors-cross-origin-resource-sharing)
- [4. Authentication (XÃ¡c thá»±c)](#4-authentication-xÃ¡c-thá»±c)
- [5. Authorization (PhÃ¢n quyá»n)](#5-authorization-phÃ¢n-quyá»n)
- [6. SSL/TLS](#6-ssltls)
- [7. Monitoring](#7-monitoring)
- [8. DDoS Protection](#8-ddos-protection)
- [9. API Aggregation](#9-api-aggregation)
- [10. Protocol Translation](#10-protocol-translation)

---

## 1. API Gateway lÃ  gÃ¬?

**API Gateway** lÃ  entry point duy nháº¥t Ä‘á»ƒ nháº­n request tá»« clients vÃ  chuyá»ƒn Ä‘áº¿n cÃ¡c microservices, giÃºp che Ä‘i cÃ¡c service con bÃªn trong.

### Nhiá»‡m vá»¥ chÃ­nh

|    Nhiá»‡m vá»¥    | MÃ´ táº£ |
|----------|-------|
| **Routing** | Chuyá»ƒn cÃ¡c request Ä‘áº¿n Ä‘Ãºng service yÃªu cáº§u |
| **Security** | Thá»±c hiá»‡n authentication vÃ  authorization, chá»‘ng táº¥n cÃ´ng Ä‘áº¿n cÃ¡c service bÃªn trong |
| **Rate Limiting** | NgÄƒn cháº·n há»‡ thá»‘ng quÃ¡ táº£i báº±ng cÃ¡ch giá»›i háº¡n request trong 1 khoáº£ng thá»i gian |
| **Monitoring** | GiÃ¡m sÃ¡t há»‡ thá»‘ng váº­n hÃ nh |
| **Caching** | LÆ°u trá»¯ data táº¡m thá»i â†’ tÄƒng hiá»‡u suáº¥t truy váº¥n |
| **Transformation** | Biáº¿n Ä‘á»•i kiá»ƒu dá»¯ liá»‡u (Ä‘á»‹nh dáº¡ng request/response) |
| **Aggregation** | Káº¿t há»£p nhiá»u lá»‡nh gá»i service thÃ nh 1 yÃªu cáº§u duy nháº¥t |

---

## 2. Cross-cutting Concerns

**Cross-cutting concerns** lÃ  má»™t pháº§n cá»§a chÆ°Æ¡ng trÃ¬nh phá»¥ thuá»™c hoáº·c pháº£i áº£nh hÆ°á»Ÿng bá»Ÿi nhiá»u module hoÃ n chá»‰nh khÃ¡c.

### Äáº·c Ä‘iá»ƒm

- á»¨ng dá»¥ng thÆ°á»ng Ä‘Æ°á»£c chia lÃ m cÃ¡c module
- Trong nhá»¯ng module nÃ y tá»“n táº¡i nhá»¯ng tÃ¡c vá»¥ báº¯t buá»™c â†’ táº¡o ra sá»± láº·p láº¡i â†’ **cross-cutting**

### CÃ¡c cross-cutting concerns phá»• biáº¿n

- **Logging** - Ghi log
- **Security** - Báº£o máº­t, authentication, authorization
- **Transaction Management** - Quáº£n lÃ½ transaction toÃ n bá»™ há»‡ thá»‘ng
- **Caching** - Bá»™ nhá»› Ä‘á»‡m
- **Error Handling** - Xá»­ lÃ½ lá»—i

---

## 3. CORS (Cross-Origin Resource Sharing)

### Same-Origin Policy

- LÃ  chÃ­nh sÃ¡ch báº£o máº­t Ä‘Æ°á»£c cÃ i vÃ o cÃ¡c trÃ¬nh duyá»‡t hiá»‡n Ä‘áº¡i
- NgÄƒn cháº·n viá»‡c truy cáº­p vÃ´ tá»™i váº¡ vÃ o cÃ¡c domain khÃ¡c
- **Quan trá»ng**: ÄÃ¢y lÃ  cÆ¡ cháº¿ báº£o máº­t cá»§a **TrÃ¬nh duyá»‡t (Browser)**, khÃ´ng pháº£i cá»§a Server

### CORS sinh ra Ä‘á»ƒ lÃ m gÃ¬?

- **CORS** Ä‘Æ°á»£c táº¡o ra Ä‘á»ƒ **ná»›i lá»ng** Same-Origin Policy má»™t cÃ¡ch cÃ³ kiá»ƒm soÃ¡t.

### Origin lÃ  gÃ¬?

```
Origin = Protocol + Domain + Port
```

**VÃ­ dá»¥:**
- `https://example.com:443` vÃ  `https://example.com:8080` lÃ  **khÃ¡c origin** (khÃ¡c port)
- `http://example.com` vÃ  `https://example.com` lÃ  **khÃ¡c origin** (khÃ¡c protocol)

### CÆ¡ cháº¿ hoáº¡t Ä‘á»™ng

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Browser â”‚                    â”‚ Server  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                              â”‚
     â”‚  1. Preflight Request        â”‚
     â”‚  (OPTIONS method)            â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                              â”‚
     â”‚  2. Preflight Response       â”‚
     â”‚  (Access-Control-* headers)  â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                              â”‚
     â”‚  3. Actual Request           â”‚
     â”‚  (GET, POST, etc.)           â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                              â”‚
     â”‚  4. Actual Response          â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                              â”‚
```

### Response Headers quan trá»ng

| Header | MÃ´ táº£ |
|--------|-------|
| `Access-Control-Allow-Origin` | CÃ¡c origin Ä‘Æ°á»£c phÃ©p truy cáº­p |
| `Access-Control-Allow-Methods` | CÃ¡c HTTP methods Ä‘Æ°á»£c phÃ©p |
| `Access-Control-Allow-Headers` | CÃ¡c headers Ä‘Æ°á»£c phÃ©p gá»­i |
| `Access-Control-Max-Age` | Thá»i gian cache preflight response |

### Má»¥c Ä‘Ã­ch báº£o máº­t

CORS giÃºp ngÄƒn cháº·n táº¥n cÃ´ng **CSRF (Cross-Site Request Forgery)**

### LÆ°u Ã½ quan trá»ng

> âš ï¸ Náº¿u `allowCredentials = true` â†’ `allowOrigins` **KHÃ”NG ÄÆ¯á»¢C** lÃ  `*`
> 
> VÃ¬ táº¥t cáº£ cÃ¡c origin sáº½ Ä‘á»u truy cáº­p Ä‘Æ°á»£c vÃ o cookies/session â†’ rá»§i ro báº£o máº­t

### Best Practice

- Náº¿u Ä‘Ã£ setup CORS á»Ÿ API Gateway â†’ **khÃ´ng cáº§n** setup á»Ÿ cÃ¡c service con

### CSRF (Cross-Site Request Forgery) lÃ  gÃ¬?

**CSRF** lÃ  lá»— há»•ng báº£o máº­t web, cho phÃ©p káº» táº¥n cÃ´ng lá»«a ngÆ°á»i dÃ¹ng thá»±c hiá»‡n cÃ¡c hÃ nh Ä‘á»™ng khÃ´ng mong muá»‘n trÃªn má»™t á»©ng dá»¥ng web mÃ  há» Ä‘Ã£ Ä‘Äƒng nháº­p.

#### CÃ¡ch CSRF hoáº¡t Ä‘á»™ng

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CSRF ATTACK FLOW                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  1. User Ä‘Äƒng nháº­p vÃ o bank.com                                         â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚     â”‚ User â”‚ â”€â”€â”€â”€â”€â”€â”€> â”‚ bank.com  â”‚  â† Session cookie Ä‘Æ°á»£c lÆ°u          â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚                                                                         â”‚
â”‚  2. User vÃ´ tÃ¬nh truy cáº­p evil.com (qua email lá»«a Ä‘áº£o, quáº£ng cÃ¡o...)    â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚     â”‚ User â”‚ â”€â”€â”€â”€â”€â”€â”€> â”‚ evil.com  â”‚                                     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚                                                                         â”‚
â”‚  3. evil.com chá»©a code Ä‘á»™c háº¡i dÆ°á»›i dáº¡ng image hoáº·c form áº©n:            â”‚
â”‚     <img src="https://bank.com/transfer?to=hacker&amount=1000000">      â”‚
â”‚     hoáº·c                                                                â”‚
â”‚     <form action="https://bank.com/transfer" method="POST">             â”‚
â”‚       <input name="to" value="hacker">                                  â”‚
â”‚       <input name="amount" value="1000000">                             â”‚
â”‚     </form>                                                             â”‚
â”‚     <script>document.forms[0].submit()</script>                         â”‚
â”‚                                                                         â”‚
â”‚  4. Browser Tá»° Äá»˜NG gá»­i request Ä‘áº¿n bank.com KÃˆM THEO session or cookie â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚     â”‚ evil.com  â”‚ â”€â”€â”€â”€â”€ Request â”€â”€â”€â”€â”€> â”‚ bank.com  â”‚                    â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ + session or cookie  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                                         â”‚
â”‚  5. bank.com nghÄ© Ä‘Ã¢y lÃ  request há»£p lá»‡ tá»« user â†’ Chuyá»ƒn tiá»n!          â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Táº¡i sao CSRF nguy hiá»ƒm?

| Äáº·c Ä‘iá»ƒm | Giáº£i thÃ­ch |
|----------|------------|
| **KhÃ´ng cáº§n Ä‘Ã¡nh cáº¯p password** | Táº­n dá»¥ng session Ä‘ang active cá»§a user |
| **User khÃ´ng biáº¿t** | HÃ nh Ä‘á»™ng xáº£y ra ngáº§m, user khÃ´ng nháº­n ra |
| **Bypass authentication** | Request Ä‘Æ°á»£c gá»­i vá»›i credentials há»£p lá»‡ cá»§a user |

#### VÃ­ dá»¥ thá»±c táº¿

**Scenario: Thay Ä‘á»•i email trong tÃ i khoáº£n**

```http
# Request há»£p lá»‡ tá»« user
POST /account/change-email
Header
Authorization: Bearer abcxyz...
Content-Type: application/x-www-form-urlencoded
Body
  email=user@example.com
```

**Attacker táº¡o trang web chá»©a:**
```html
<!-- Trang web evil.com -->
<html>
  <body onload="document.getElementById('csrf-form').submit()">
    <form id="csrf-form" action="https://target.com/account/change-email" method="POST">
      <input type="hidden" name="email" value="hacker@evil.com">
    </form>
  </body>
</html>
```

**Káº¿t quáº£:** Email cá»§a user bá»‹ Ä‘á»•i thÃ nh email cá»§a hacker â†’ Hacker cÃ³ thá»ƒ reset password!

#### CÃ¡c biá»‡n phÃ¡p chá»‘ng CSRF

| Biá»‡n phÃ¡p | MÃ´ táº£ | Hiá»‡u quáº£ |
|-----------|-------|----------|
| **CSRF Token** | Server sinh token ngáº«u nhiÃªn, client pháº£i gá»­i kÃ¨m má»—i request | â­â­â­â­â­ |
| **SameSite Cookie** | Cookie chá»‰ Ä‘Æ°á»£c gá»­i vá»›i request tá»« same origin | â­â­â­â­ |
| **Double Submit Cookie** | Gá»­i token trong cáº£ cookie vÃ  request body | â­â­â­â­ |
| **Check Referer/Origin Header** | Kiá»ƒm tra request Ä‘áº¿n tá»« domain nÃ o | â­â­â­ |
| **Custom Headers** | YÃªu cáº§u header Ä‘áº·c biá»‡t (X-Requested-With) | â­â­â­ |

#### CSRF Token hoáº¡t Ä‘á»™ng nhÆ° tháº¿ nÃ o?

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client â”‚                              â”‚ Server â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
    â”‚  1. GET /form                         â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€->â”‚
    â”‚  2. Response kÃ¨m CSRF token           â”‚
    â”‚  <input type="hidden"                 â”‚
    â”‚   name="_csrf"                        â”‚
    â”‚   value="random-token-xyz">           â”‚
    â”‚<-â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚  3. POST /submit                      â”‚
    â”‚  Body: data + _csrf=random-token-xyz  â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€->â”‚
    â”‚  4. Server verify token               â”‚
    â”‚     Token khá»›p? â†’ OK                  â”‚
    â”‚     Token khÃ´ng khá»›p? â†’ 403 Forbidden â”‚
    â”‚                                       â”‚
```

**Táº¡i sao CSRF Token hiá»‡u quáº£?**
- Attacker **khÃ´ng thá»ƒ Ä‘á»c** token tá»« trang web khÃ¡c (Same-Origin Policy)
- Má»—i session cÃ³ token **khÃ¡c nhau** vÃ  thay Ä‘á»•i liÃªn tá»¥c má»—i request
- Token **khÃ´ng thá»ƒ Ä‘oÃ¡n** Ä‘Æ°á»£c (random)

#### SameSite Cookie Attribute

```http
Set-Cookie: session=abc123; SameSite=Strict
Set-Cookie: session=abc123; SameSite=Lax
Set-Cookie: session=abc123; SameSite=None; Secure
```

| GiÃ¡ trá»‹ | Behavior |
|---------|----------|
| **Strict** | Cookie KHÃ”NG Ä‘Æ°á»£c gá»­i vá»›i báº¥t ká»³ cross-site request nÃ o |
| **Lax** | Cookie Ä‘Æ°á»£c gá»­i vá»›i navigation (click link) nhÆ°ng khÃ´ng vá»›i POST form |
| **None** | Cookie Ä‘Æ°á»£c gá»­i vá»›i má»i request (cáº§n Secure flag) |

#### CORS vs CSRF - Má»‘i quan há»‡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CORS GIÃšP CHá»NG CSRF NHÆ¯ THáº¾ NÃ€O?                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  1. evil.com muá»‘n gá»­i request Ä‘áº¿n bank.com                          â”‚
â”‚                                                                     â”‚
â”‚  2. Browser gá»­i Preflight request (OPTIONS)                         â”‚
â”‚     Origin: https://evil.com                                        â”‚
â”‚                                                                     â”‚
â”‚  3. bank.com tráº£ vá»:                                                â”‚
â”‚     Access-Control-Allow-Origin: https://bank.com  â† KhÃ´ng cÃ³ evil  â”‚
â”‚                                                                     â”‚
â”‚  4. Browser CHáº¶N request tá»« evil.com                                â”‚
â”‚                                                                     â”‚
â”‚   LÆ¯U Ã: CORS chá»‰ cháº·n Ä‘Æ°á»£c request phá»©c táº¡p (custom headers,       â”‚
â”‚     JSON content-type). Simple requests (form POST) váº«n Ä‘Æ°á»£c gá»­i!   â”‚
â”‚                                                                     â”‚
â”‚  â†’ Váº«n cáº§n CSRF Token cho báº£o vá»‡ hoÃ n toÃ n                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. Authentication (XÃ¡c thá»±c)

**Authentication** lÃ  quÃ¡ trÃ¬nh xÃ¡c minh danh tÃ­nh ngÆ°á»i dÃ¹ng táº¡i má»™t thá»i Ä‘iá»ƒm duy nháº¥t trÆ°á»›c khi chuyá»ƒn Ä‘áº¿n cÃ¡c service con.

### CÃ¡c cÆ¡ cháº¿ phá»• biáº¿n

| CÆ¡ cháº¿ | Äáº·c Ä‘iá»ƒm |
|--------|----------|
| **JWT** | Phá»• biáº¿n nháº¥t, kiá»ƒm tra token mÃ  khÃ´ng cáº§n truy váº¥n database |
| **OAuth 2.0** | Chuáº©n authorization, cho phÃ©p third-party access |
| **API Key** | ÄÆ¡n giáº£n, thÆ°á»ng dÃ¹ng cho server-to-server |

### Lá»£i Ã­ch cá»§a Authentication táº­p trung

- âœ… **Táº­p trung hÃ³a báº£o máº­t**: Chá»‰ cáº§n xÃ¡c thá»±c 1 láº§n
- âœ… **Há»— trá»£ nhiá»u phÆ°Æ¡ng thá»©c**: JWT, OAuth2, API Key...
- âœ… **Quáº£n lÃ½ phiÃªn**: Session management táº­p trung
- âœ… **Giáº£m táº£i**: CÃ¡c microservice khÃ´ng cáº§n xá»­ lÃ½ authentication

### Quy trÃ¬nh xÃ¡c thá»±c vá»›i JWT

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client â”‚         â”‚ API Gateway â”‚         â”‚ Microservice â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                     â”‚                       â”‚
    â”‚ 1. Request vá»›i      â”‚                       â”‚
    â”‚ Authorization:      â”‚                       â”‚
    â”‚ Bearer <JWT>        â”‚                       â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚
    â”‚                     â”‚                       â”‚
    â”‚                     â”‚ 2. Validate JWT       â”‚
    â”‚                     â”‚    - Giáº£i mÃ£          â”‚
    â”‚                     â”‚    - Kiá»ƒm tra háº¡n     â”‚
    â”‚                     â”‚    - Kiá»ƒm tra chá»¯ kÃ½  â”‚
    â”‚                     â”‚                       â”‚
    â”‚                     â”‚ 3. Náº¿u há»£p lá»‡:        â”‚
    â”‚                     â”‚    Gáº¯n user info      â”‚
    â”‚                     â”‚    vÃ o header         â”‚
    â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                     â”‚                       â”‚
    â”‚ 4. Náº¿u khÃ´ng há»£p lá»‡:â”‚                       â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                       â”‚
    â”‚ 401 Unauthorized    â”‚                       â”‚
    â”‚                     â”‚                       â”‚
```

### JWT Validation Steps

1. Kiá»ƒm tra format: `Bearer <token>`
2. **Giáº£i mÃ£ (Decode)** token
3. **Kiá»ƒm tra expiration** (háº¡n sá»­ dá»¥ng)
4. **Verify signature** (chá»¯ kÃ½)
5. TrÃ­ch xuáº¥t claims (user info)

---

## 5. Authorization (PhÃ¢n quyá»n)

**Authorization** lÃ  quÃ¡ trÃ¬nh xÃ¡c Ä‘á»‹nh ngÆ°á»i dÃ¹ng (sau khi Ä‘Ã£ authentication) cÃ³ quyá»n thá»±c hiá»‡n nhá»¯ng hÃ nh Ä‘á»™ng cá»¥ thá»ƒ nÃ o.

### Chiáº¿n lÆ°á»£c phÃ¢n quyá»n

| Chiáº¿n lÆ°á»£c | MÃ´ táº£ | Use Case |
|------------|-------|----------|
| **RBAC** (Role-Based Access Control) | PhÃ¢n quyá»n dá»±a trÃªn **role** | Admin, User, Manager |
| **ABAC** (Attribute-Based Access Control) | PhÃ¢n quyá»n dá»±a trÃªn **thuá»™c tÃ­nh** cá»§a user, tÃ i nguyÃªn vÃ  mÃ´i trÆ°á»ng | Department, Location, Time |

### Quy trÃ¬nh Authorization

```
        1. TrÃ­ch xuáº¥t token tá»« Header
                         â†“
        2. Giáº£i mÃ£ vÃ  kiá»ƒm tra JWT (expiration, signature)
                         â†“
        3. Kiá»ƒm tra claims (role, scope, permissions)
                         â†“
        4. Äá»‘i chiáº¿u vá»›i endpoint cá»§a request
                         â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   PhÃ¹ há»£p      â”‚  KhÃ´ng phÃ¹ há»£p â”‚
        â”‚       â†“        â”‚        â†“       â”‚
        â”‚ Forward requestâ”‚  403 Forbidden â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### MÃ´ hÃ¬nh phÃ¢n quyá»n 2 lá»›p

```
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                     API GATEWAY                   â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚  Kiá»ƒm tra tá»•ng quÃ¡t: User cÃ³ quyá»n truy cáº­p       â”‚
        â”‚  vÃ o Cá»¤M API nÃ y khÃ´ng?                           â”‚
        â”‚  â†’ KhÃ´ng há»£p lá»‡: 403 Forbidden                    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚ Há»£p lá»‡
                                 â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                    MICROSERVICE                   â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚  Kiá»ƒm tra chi tiáº¿t: User cÃ³ quyá»n thá»±c hiá»‡n       â”‚
        â”‚  HÃ€NH Äá»˜NG Cá»¤ THá»‚ nÃ y khÃ´ng?                      â”‚
        â”‚  â†’ Náº¿u khÃ´ng cÃ³: 403 Forbidden                    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Æ¯u Ä‘iá»ƒm cá»§a mÃ´ hÃ¬nh 2 lá»›p:**
- API Gateway cháº·n sá»›m cÃ¡c request khÃ´ng há»£p lá»‡
- Microservice xá»­ lÃ½ business logic authorization phá»©c táº¡p

---

## 6. SSL/TLS

### SSL (Secure Socket Layer)

- Giao thá»©c báº£o máº­t Ä‘á»i Ä‘áº§u (Netscape, 1990s)
- **Nhiá»‡m vá»¥**: MÃ£ hÃ³a dá»¯ liá»‡u trÃªn internet
- **Tráº¡ng thÃ¡i**: âŒ ÄÃ£ lá»—i thá»i do nhiá»u lá»— há»•ng báº£o máº­t

### TLS (Transport Layer Security)

- PhiÃªn báº£n nÃ¢ng cáº¥p cá»§a SSL
- **Nhiá»‡m vá»¥**: Giá»‘ng SSL nhÆ°ng mÃ£ hÃ³a máº¡nh máº½ hÆ¡n
- **Tráº¡ng thÃ¡i**: âœ… TiÃªu chuáº©n hiá»‡n táº¡i (TLS 1.2, 1.3)

> ğŸ’¡ **LÆ°u Ã½**: Khi nÃ³i "SSL" ngÃ y nay, thá»±c cháº¥t vá» máº·t ká»¹ thuáº­t lÃ  TLS 1.2 hoáº·c 1.3

### Quy trÃ¬nh TLS Handshake

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client â”‚                              â”‚ Server â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
    â”‚                                       â”‚
    â”‚ 1. Client Hello                       â”‚
    â”‚    (TLS versions, cipher suites)      â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                                       â”‚
    â”‚ 2. Server Hello + Certificate         â”‚
    â”‚    (Certificate chá»©a Public Key)      â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                                       â”‚
    â”‚ 3. Certificate Verification           â”‚
    â”‚    (Browser kiá»ƒm tra cert há»£p lá»‡)     â”‚
    â”‚                                       â”‚
    â”‚ 4. Key Exchange                       â”‚
    â”‚    (Gá»­i Session Key Ä‘Ã£ mÃ£ hÃ³a         â”‚
    â”‚     báº±ng Public Key cá»§a Server)       â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                                       â”‚
    â”‚ 5. Server giáº£i mÃ£ báº±ng Private Key    â”‚
    â”‚    â†’ Láº¥y Ä‘Æ°á»£c Session Key             â”‚
    â”‚                                       â”‚
    â”‚ 6. Secure Connection                  â”‚
    â”‚    (Cáº£ 2 dÃ¹ng Session Key Ä‘á»ƒ          â”‚
    â”‚     mÃ£ hÃ³a Ä‘á»‘i xá»©ng)                  â”‚
    â”‚<â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•>â”‚
    â”‚                                       â”‚
```

### SSL/TLS trong API Gateway

| Mode | MÃ´ táº£ | Æ¯u Ä‘iá»ƒm | NhÆ°á»£c Ä‘iá»ƒm |
|------|-------|---------|------------|
| **SSL Termination** | Gateway giáº£i mÃ£ HTTPS â†’ gá»­i HTTP Ä‘áº¿n microservice | Giáº£m táº£i cho microservice, quáº£n lÃ½ cert táº­p trung | Traffic ná»™i bá»™ khÃ´ng mÃ£ hÃ³a |
| **SSL Passthrough** | Gateway chá»‰ forward HTTPS, microservice tá»± giáº£i mÃ£ | Báº£o máº­t tá»‘i Ä‘a end-to-end | TÄƒng táº£i cho microservice |

### Táº¡i sao cáº§n SSL/TLS?

| LÃ½ do | Giáº£i thÃ­ch |
|-------|------------|
| **MÃ£ hÃ³a dá»¯ liá»‡u** | TrÃ¡nh táº¥n cÃ´ng Man-In-The-Middle |
| **XÃ¡c thá»±c Server** | Äáº£m báº£o káº¿t ná»‘i Ä‘áº¿n server chÃ­nh chá»§ |
| **ToÃ n váº¹n dá»¯ liá»‡u** | Äáº£m báº£o data khÃ´ng bá»‹ thay Ä‘á»•i |
| **SEO** | Google Æ°u tiÃªn cÃ¡c trang HTTPS |

---

## 7. Monitoring

**Monitoring** lÃ  giÃ¡m sÃ¡t toÃ n bá»™ há»‡ thá»‘ng, theo dÃµi hiá»‡u suáº¥t vÃ  hoáº¡t Ä‘á»™ng cá»§a cÃ¡c API.

### 7.1 Metrics (Chá»‰ sá»‘ Ä‘á»‹nh lÆ°á»£ng)

| Metric | MÃ´ táº£ | ÄÆ¡n vá»‹ |
|--------|-------|--------|
| **Throughput** | Sá»‘ lÆ°á»£ng request má»—i giÃ¢y | RPS (Requests Per Second) |
| **Latency** | Thá»i gian pháº£n há»“i | ms (milliseconds) |
| **Error Rate** | Tá»· lá»‡ lá»—i 4xx vÃ  5xx | % |
| **Resource Usage** | CPU vÃ  RAM sá»­ dá»¥ng | % |

### 7.2 Logging (Nháº­t kÃ½ chi tiáº¿t)

#### Access Logs

```json
{
  "timestamp": "2024-01-15T10:30:00Z",
  "client_ip": "192.168.1.100",
  "method": "POST",
  "path": "/api/users",
  "status_code": 201,
  "latency_ms": 45,
  "user_agent": "Mozilla/5.0..."
}
```

#### Error Logs

```json
{
  "timestamp": "2024-01-15T10:31:00Z",
  "error": "ServiceUnavailable",
  "message": "Connection timeout to user-service",
  "stack_trace": "...",
  "request_id": "abc-123"
}
```

#### Logging táº­p trung

**Lá»£i Ã­ch:**
- âœ… Chá»‰ cáº§n má»Ÿ 1 giao diá»‡n Ä‘á»ƒ xem log toÃ n há»‡ thá»‘ng
- âœ… Xá»­ lÃ½ sá»± cá»‘ ngay láº­p tá»©c: xÃ¡c Ä‘á»‹nh lá»—i tá»« service nÃ o
- âœ… PhÃ¢n tÃ­ch dá»¯ liá»‡u: dá»±a vÃ o log Ä‘á»ƒ phÃ¢n tÃ­ch trend

### 7.3 Distributed Tracing (Truy váº¿t phÃ¢n tÃ¡n)

Gateway sinh ra má»™t **Correlation ID** (hoáº·c **Trace ID**) duy nháº¥t cho má»—i request vÃ  Ä‘Ã­nh kÃ¨m vÃ o header.

#### Hai thá»±c thá»ƒ chÃ­nh

  | Thá»±c thá»ƒ | MÃ´ táº£ |
  |----------|-------|
  | **Trace** | Life cycle cá»§a má»™t request (toÃ n bá»™ hÃ nh trÃ¬nh) |
  | **Span** | Äáº¡i diá»‡n cho má»™t phÃ¢n Ä‘oáº¡n trong hÃ nh trÃ¬nh |

#### CÆ¡ cháº¿ hoáº¡t Ä‘á»™ng

```
          
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   req    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
| Client  |--------->â”‚ API Gateway â”‚â”€â”€â”€>â”‚  Service A  â”‚â”€â”€â”€>â”‚  Service B  â”‚â”€â”€â”€>â”‚  Service C  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚                  â”‚                  â”‚                  â”‚
                            â”‚  Trace ID:       â”‚                  â”‚                  â”‚
                            â”‚  abc-123         â”‚                  â”‚                  â”‚
                            â”‚                  â”‚                  â”‚                  â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          Header: X-B3-TraceId: abc-123
```

**Quy trÃ¬nh:**
1. API Gateway sinh **Trace ID** vÃ  gáº¯n vÃ o header (`X-B3-TraceId`)
2. Má»—i service con láº¥y Trace ID Ä‘á»ƒ log ná»™i bá»™
3. Trace ID tá»“n táº¡i cho Ä‘áº¿n khi request káº¿t thÃºc

### 7.4 Health Checks

Gateway kiá»ƒm tra cÃ¡c service con liÃªn tá»¥c. Náº¿u service lá»—i â†’ khÃ´ng forward request Ä‘áº¿n service Ä‘Ã³.

| Loáº¡i | CÆ¡ cháº¿ | Æ¯u Ä‘iá»ƒm |
|------|--------|---------|
| **Active Health Check** | Gateway gá»­i request "thÄƒm dÃ²" Ä‘áº¿n `/health` Ä‘á»‹nh ká»³ (má»—i 5s) | PhÃ¡t hiá»‡n lá»—i khÃ´ng cáº§n traffic tá»« user |
| **Passive Health Check** | Gateway quan sÃ¡t response. Náº¿u 5 request liÃªn tiáº¿p tráº£ vá» 5xx â†’ Ä‘Ã¡nh dáº¥u service lá»—i | KhÃ´ng tá»‘n thÃªm request, káº¿t há»£p vá»›i **Circuit Breaker** |


### Circuit Breaker lÃ  gÃ¬?

**Circuit Breaker** lÃ  má»™t design pattern quan trá»ng trong Distributed System vÃ  Microservices, dÃ¹ng Ä‘á»ƒ xá»­ lÃ½ lá»—i vÃ  Ä‘áº£m báº£o tÃ­nh á»•n Ä‘á»‹nh cá»§a cáº£ há»‡ thá»‘ng.

#### SÆ¡ Ä‘á»“ tráº¡ng thÃ¡i Circuit Breaker

```
                            
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                                                â”‚
        â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” (1)Threshold    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
        â”‚    â”‚  CLOSED  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚   OPEN   â”‚   Back to OPEN    â”‚
        â”‚    â”‚ (Normal) â”‚    exceeded     â”‚  (Fail   â”‚  <----------â”     â”‚
        â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚   Fast)  â”‚             |     â”‚
        â”‚         â–²                       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜             |     â”‚
        â”‚         â”‚                            â”‚                   |     â”‚
        â”‚         â”‚ Success                    â”‚ (2)Timeout        |     â”‚
        â”‚         â”‚                            â”‚ (wait period)     |     â”‚
        â”‚         â”‚                            â–¼                   |     â”‚
        â”‚         â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             |     â”‚
        â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ HALF-OPEN â”‚             |     â”‚
        â”‚               (3.1)Success     â”‚  (Test)   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
        â”‚                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  (3.2)Failure     â”‚
        â”‚                                                                â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### CÃ¡c tráº¡ng thÃ¡i cá»§a Circuit Breaker

| Tráº¡ng thÃ¡i | MÃ´ táº£ | HÃ nh vi |
|------------|-------|---------|
| **CLOSED** (BÃ¬nh thÆ°á»ng) | Há»‡ thá»‘ng hoáº¡t Ä‘á»™ng á»•n Ä‘á»‹nh | Táº¥t cáº£ request Ä‘Æ°á»£c cho phÃ©p Ä‘i qua. Breaker Ä‘áº¿m sá»‘ lá»—i (trong 1 khoáº£ng thá»i gian ngáº¯n), náº¿u vÆ°á»£t **threshold** â†’ chuyá»ƒn sang **OPEN** |
| **OPEN** (Ngáº¯t máº¡ch) | PhÃ¡t hiá»‡n service Ä‘ang gáº·p sá»± cá»‘ | Cháº·n má»i request, tráº£ vá» lá»—i/fallback ngay láº­p tá»©c (**Fail Fast**). Sau **timeout period** â†’ chuyá»ƒn sang **HALF-OPEN** |
| **HALF-OPEN** (Thá»­ nghiá»‡m) | Kiá»ƒm tra service Ä‘Ã£ há»“i phá»¥c chÆ°a | Cho phÃ©p **má»™t sá»‘ Ã­t request** Ä‘i qua Ä‘á»ƒ test. ThÃ nh cÃ´ng â†’ **CLOSED**. Tháº¥t báº¡i â†’ quay láº¡i **OPEN** |

#### VÃ­ dá»¥ thá»±c táº¿

```
KhÃ´ng cÃ³ Circuit Breaker:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
User â”€â”€â–º API Gateway â”€â”€â–º Order Service â”€â”€â–º Payment Service (DEAD)
                                                    â”‚
                                              Timeout 30s...
                                              Timeout 30s...
                                              Timeout 30s...
                                                    â”‚
                                              âŒ Requests á»© Ä‘á»ng
                                              âŒ Thread pool cáº¡n kiá»‡t
                                              âŒ Cáº£ há»‡ thá»‘ng sá»¥p Ä‘á»•

CÃ³ Circuit Breaker:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
User â”€â”€â–º API Gateway â”€â”€â–º Order Service â”€â”€â–º Circuit Breaker â”€â”€Xâ”€â”€ Payment Service (DEAD)
                                                â”‚
                                          Fail Fast! (5ms)
                                          Return fallback
                                                â”‚
                                          âœ… User nháº­n response nhanh
                                          âœ… Há»‡ thá»‘ng váº«n hoáº¡t Ä‘á»™ng
                                          âœ… Payment Service cÃ³ thá»i gian há»“i phá»¥c
```

#### CÃ¡c thÃ´ng sá»‘ cáº¥u hÃ¬nh quan trá»ng

| ThÃ´ng sá»‘ | MÃ´ táº£ | GiÃ¡ trá»‹ vÃ­ dá»¥ |
|----------|-------|---------------|
| **failureRateThreshold** | Tá»· lá»‡ lá»—i Ä‘á»ƒ kÃ­ch hoáº¡t OPEN | 50% |
| **slowCallRateThreshold** | Tá»· lá»‡ request cháº­m Ä‘á»ƒ kÃ­ch hoáº¡t OPEN | 80% |
| **slowCallDurationThreshold** | NgÆ°á»¡ng thá»i gian Ä‘Æ°á»£c coi lÃ  request cháº­m | 2000ms |
| **waitDurationInOpenState** | Thá»i gian chá» á»Ÿ tráº¡ng thÃ¡i OPEN trÆ°á»›c khi chuyá»ƒn HALF-OPEN | 60s |
| **permittedNumberOfCallsInHalfOpenState** | Sá»‘ request test á»Ÿ tráº¡ng thÃ¡i HALF-OPEN | 10 |
| **slidingWindowSize** | Sá»‘ request gáº§n nháº¥t Ä‘á»ƒ tÃ­nh toÃ¡n failure rate | 100 |

#### VÃ­ dá»¥ cáº¥u hÃ¬nh vá»›i Resilience4j (Spring Boot)

```yaml
resilience4j:
  circuitbreaker:
    instances:
      paymentService:
        registerHealthIndicator: true # cho phÃ©p Spring Boot Actuator giÃ¡m sÃ¡t tráº¡ng thÃ¡i cá»§a circuit breaker
        slidingWindowSize: 100
        failureRateThreshold: 50
        waitDurationInOpenState: 30000      # 30 seconds
        permittedNumberOfCallsInHalfOpenState: 10
        slowCallRateThreshold: 80
        slowCallDurationThreshold: 2000     # 2 seconds
```

```java
@Service
public class OrderService {
    
    @CircuitBreaker(name = "paymentService", fallbackMethod = "paymentFallback")
    public PaymentResponse processPayment(PaymentRequest request) {
        return paymentClient.pay(request);
    }
    
    // Fallback method - Ä‘Æ°á»£c gá»i khi circuit OPEN
    public PaymentResponse paymentFallback(PaymentRequest request, Exception ex) {
        return PaymentResponse.builder()
            .status("PENDING")
            .message("Payment service is temporarily unavailable. Your order is queued.")
            .build();
    }
}
```

#### Táº¡i sao cáº§n Circuit Breaker?

| LÃ½ do | Giáº£i thÃ­ch |
|-------|------------|
| **NgÄƒn cháº·n lá»—i dÃ¢y chuyá»n (Cascading Failure)** | Khi 1 service lá»—i, cÃ¡c request á»© Ä‘á»ng sáº½ lÃ m cáº¡n kiá»‡t resources (threads, connections) â†’ áº£nh hÆ°á»Ÿng cÃ¡c service khÃ¡c â†’ cáº£ há»‡ thá»‘ng sá»¥p Ä‘á»• |
| **Giáº£m táº£i cho service Ä‘ang lá»—i** | Cho service lá»—i "nghá»‰ ngÆ¡i" Ä‘á»ƒ cÃ³ thá»i gian há»“i phá»¥c, thay vÃ¬ tiáº¿p tá»¥c nháº­n request |
| **Fail Fast** | Tráº£ vá» lá»—i/fallback ngay láº­p tá»©c (5ms) thay vÃ¬ Ä‘á»ƒ user chá» timeout (30s) |
| **Cáº£i thiá»‡n UX** | User nháº­n Ä‘Æ°á»£c response nhanh vá»›i thÃ´ng bÃ¡o há»¯u Ã­ch, cÃ³ thá»ƒ thá»±c hiá»‡n thao tÃ¡c khÃ¡c |
| **Tá»± Ä‘á»™ng phá»¥c há»“i** | Khi service há»“i phá»¥c, Circuit Breaker tá»± Ä‘á»™ng detect vÃ  cho phÃ©p traffic trá»Ÿ láº¡i |

---

## 8. DDoS Protection

### DDoS lÃ  gÃ¬?

**DDoS (Distributed Denial of Service)** lÃ  má»™t cuá»™c táº¥n cÃ´ng máº¡ng trong Ä‘Ã³ káº» táº¥n cÃ´ng sá»­ dá»¥ng nhiá»u nguá»“n (botnet) Ä‘á»ƒ gá»­i lÆ°á»£ng lá»›n request Ä‘áº¿n há»‡ thá»‘ng, lÃ m cho há»‡ thá»‘ng bá»‹ quÃ¡ táº£i vÃ  khÃ´ng thá»ƒ phá»¥c vá»¥ ngÆ°á»i dÃ¹ng há»£p lá»‡.

### CÃ¡c loáº¡i táº¥n cÃ´ng DDoS phá»• biáº¿n

| Loáº¡i táº¥n cÃ´ng | Layer | MÃ´ táº£ | VÃ­ dá»¥ |
|---------------|-------|-------|-------|
| **Volumetric Attacks** | Layer 3/4 | Táº¥n cÃ´ng báº±ng lÆ°á»£ng traffic khá»•ng lá»“ | UDP Flood, ICMP Flood |
| **Protocol Attacks** | Layer 3/4 | Khai thÃ¡c Ä‘iá»ƒm yáº¿u cá»§a giao thá»©c máº¡ng | SYN Flood, Ping of Death |
| **Application Layer Attacks** | Layer 7 | Táº¥n cÃ´ng vÃ o á»©ng dá»¥ng, khÃ³ phÃ¡t hiá»‡n hÆ¡n | HTTP Flood, Slowloris |

### Táº¡i sao API Gateway lÃ  nÆ¡i lÃ½ tÆ°á»Ÿng Ä‘á»ƒ chá»‘ng DDoS?

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   Attacker â”€â”€â”€â”€â”€â”€â”€>â”‚                             â”‚
   Attacker â”€â”€â”€â”€â”€â”€â”€>â”‚       API GATEWAY           â”‚â”€â”€Xâ”€â”€> Microservices
   Attacker â”€â”€â”€â”€â”€â”€â”€>â”‚   (DDoS Protection Layer)   â”‚       (Protected)
   Legit User â”€â”€â”€â”€â”€>â”‚                             â”‚â”€â”€â”€â”€â”€â”€> Microservices
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    Cháº·n traffic Ä‘á»™c háº¡i
                    táº¡i entry point duy nháº¥t
```

**LÃ½ do:**
- âœ… **Single entry point**: Táº¥t cáº£ traffic Ä‘á»u Ä‘i qua Gateway
- âœ… **Báº£o vá»‡ táº­p trung**: KhÃ´ng cáº§n implement á»Ÿ tá»«ng microservice
- âœ… **PhÃ¡t hiá»‡n sá»›m**: Cháº·n trÆ°á»›c khi traffic Ä‘áº¿n backend

### CÃ¡c ká»¹ thuáº­t chá»‘ng DDoS táº¡i API Gateway

#### 8.1 Rate Limiting

Giá»›i háº¡n sá»‘ lÆ°á»£ng request tá»« má»™t nguá»“n trong khoáº£ng thá»i gian nháº¥t Ä‘á»‹nh.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RATE LIMITING                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  IP: 192.168.1.100                                     â”‚
â”‚  â”œâ”€â”€ Limit: 100 requests/minute                        â”‚
â”‚  â”œâ”€â”€ Current: 100 requests                             â”‚
â”‚  â””â”€â”€ Status: â›” BLOCKED (retry after 30s)              â”‚
â”‚                                                        â”‚
â”‚  IP: 192.168.1.101                                     â”‚
â”‚  â”œâ”€â”€ Limit: 100 requests/minute                        â”‚
â”‚  â”œâ”€â”€ Current: 45 requests                              â”‚
â”‚  â””â”€â”€ Status: âœ… ALLOWED                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**CÃ¡c thuáº­t toÃ¡n Rate Limiting:**

| Thuáº­t toÃ¡n | MÃ´ táº£ | Æ¯u Ä‘iá»ƒm | NhÆ°á»£c Ä‘iá»ƒm |
|------------|-------|---------|------------|
| **Fixed Window** | Äáº¿m request trong cá»­a sá»• thá»i gian cá»‘ Ä‘á»‹nh | ÄÆ¡n giáº£n, dá»… implement | Burst traffic á»Ÿ biÃªn cá»­a sá»• |
| **Sliding Window** | Cá»­a sá»• thá»i gian trÆ°á»£t liÃªn tá»¥c | MÆ°á»£t hÆ¡n Fixed Window | Phá»©c táº¡p hÆ¡n |
| **Token Bucket** | Má»—i request tiÃªu tá»‘n 1 token, token Ä‘Æ°á»£c bá»• sung theo thá»i gian | Cho phÃ©p burst há»£p lÃ½ | Cáº§n quáº£n lÃ½ token |
| **Leaky Bucket** | Request Ä‘Æ°á»£c xá»­ lÃ½ vá»›i tá»‘c Ä‘á»™ cá»‘ Ä‘á»‹nh | á»”n Ä‘á»‹nh traffic | KhÃ´ng linh hoáº¡t vá»›i burst |

#### 8.2 IP Blacklisting/Whitelisting

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           IP FILTERING              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  WHITELIST (Always Allow):          â”‚
â”‚  â€¢ 10.0.0.0/8 (Internal)            â”‚<--- Sá»­ dá»¥ng cho cÃ¡c api ná»™i bá»™
â”‚  â€¢ 203.0.113.50 (Partner)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  BLACKLIST (Always Block):          â”‚
â”‚  â€¢ 192.0.2.0/24 (Known attackers)   â”‚<--- Sá»­ dá»¥ng cho cÃ¡c api public
â”‚  â€¢ 198.51.100.0/24 (Suspicious)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 8.3 Geo-blocking

Cháº·n traffic tá»« cÃ¡c quá»‘c gia/khu vá»±c khÃ´ng mong muá»‘n.

```java
// VÃ­ dá»¥: Chá»‰ cho phÃ©p traffic tá»« Vietnam vÃ  Singapore
if (!allowedCountries.contains(geoIP.getCountry(clientIP))) {
    return ResponseEntity.status(403).body("Access denied from your region");
}
```

#### 8.4 Request Validation

Kiá»ƒm tra vÃ  loáº¡i bá» cÃ¡c request báº¥t thÆ°á»ng:

- âŒ Request vá»›i payload quÃ¡ lá»›n
- âŒ Request vá»›i headers báº¥t thÆ°á»ng
- âŒ Request rate cao báº¥t thÆ°á»ng tá»« má»™t IP
- âŒ Request pattern giá»‘ng bot (khÃ´ng cÃ³ cookies, user-agent láº¡)

#### 8.5 CAPTCHA Challenge

Khi phÃ¡t hiá»‡n traffic Ä‘Ã¡ng ngá», yÃªu cáº§u user xÃ¡c thá»±c lÃ  ngÆ°á»i tháº­t:

```
Normal User â”€â”€> API Gateway â”€â”€> Microservice
                    â”‚
Suspicious   â”€â”€> API Gateway â”€â”€> CAPTCHA â”€â”€> Verified? â”€â”€> Microservice
Traffic             â”‚                            â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€ Blocked <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ (Failed)
```

### Response khi bá»‹ Rate Limit

```http
HTTP/1.1 429 Too Many Requests
Content-Type: application/json
Retry-After: 30
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 0
X-RateLimit-Reset: 1640000000

{
  "error": "rate_limit_exceeded",
  "message": "Too many requests. Please retry after 30 seconds.",
  "retry_after": 30
}
```

---

## 9. API Aggregation

### API Aggregation lÃ  gÃ¬?

**API Aggregation** (hay cÃ²n gá»i lÃ  **API Composition**) lÃ  ká»¹ thuáº­t káº¿t há»£p nhiá»u API calls Ä‘áº¿n cÃ¡c microservices khÃ¡c nhau thÃ nh má»™t response duy nháº¥t cho client.

### Váº¥n Ä‘á» cáº§n giáº£i quyáº¿t

Trong kiáº¿n trÃºc microservices, má»™t trang web cÃ³ thá»ƒ cáº§n data tá»« nhiá»u services:

```
âŒ KHÃ”NG CÃ“ AGGREGATION (Client gá»i nhiá»u API):

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     GET /users/123        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ User Service â”‚
â”‚        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚
â”‚        â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚        â”‚     GET /orders?user=123  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ Order Service â”‚
â”‚        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚
â”‚        â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚        â”‚     GET /products/456     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ Product Service â”‚
â”‚        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Váº¥n Ä‘á»:
â€¢ 3 round trips tá»« client
â€¢ Client pháº£i biáº¿t vá» internal services
â€¢ TÄƒng latency (Ä‘áº·c biá»‡t trÃªn mobile network)
â€¢ Client pháº£i tá»± aggregate data
```

### Giáº£i phÃ¡p vá»›i API Aggregation

```
âœ… CÃ“ AGGREGATION (Client chá»‰ gá»i 1 API):

                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                     â”Œâ”€â”€â”€>â”‚ User Service â”‚
                                     â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   GET /user-profile/123   |
â”‚        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client â”‚                           â”‚â”€â”€â”€>â”‚ Order Service â”‚
â”‚        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   Aggregated Response     â”‚
                                     |    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                     â””â”€â”€â”€>â”‚ Product Service â”‚
                          API Gateway     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         (Aggregator)
```

### VÃ­ dá»¥ Response

**Request:**
```http
GET /api/user-dashboard/123
```

**Aggregated Response:**
```json
{
  "user": {
    "id": 123,
    "name": "Nguyen Van A",
    "email": "a@example.com"
  },
  "recentOrders": [
    {
      "orderId": "ORD-001",
      "total": 500000,
      "status": "delivered"
    },
    {
      "orderId": "ORD-002", 
      "total": 1200000,
      "status": "processing"
    }
  ],
  "recommendations": [
    {
      "productId": "P-456",
      "name": "Sáº£n pháº©m gá»£i Ã½",
      "price": 299000
    }
  ],
  "notifications": {
    "unread": 5
  }
}
```

### Patterns trong API Aggregation

#### 9.1 API Gateway Aggregation

Gateway tá»± thá»±c hiá»‡n viá»‡c gá»i cÃ¡c services vÃ  tá»•ng há»£p:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     API GATEWAY                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              Aggregation Logic                    â”‚  â”‚
â”‚  â”‚  1. Parse request                                 â”‚  â”‚
â”‚  â”‚  2. Call Service A, B, C (parallel)               â”‚  â”‚
â”‚  â”‚  3. Wait for all responses                        â”‚  â”‚
â”‚  â”‚  4. Merge & transform data                        â”‚  â”‚
â”‚  â”‚  5. Return single response                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 9.2 Backend for Frontend (BFF)

Táº¡o má»™t service riÃªng Ä‘á»ƒ aggregate cho tá»«ng loáº¡i client:

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   Mobile App â”€â”€â”€â”€â”€>â”‚   Mobile BFF    â”‚â”€â”€â”€â”€â”
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
                                           â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”œâ”€â”€â”€>â”‚ Services â”‚
   Web App â”€â”€â”€â”€â”€â”€â”€â”€>â”‚    Web BFF      â”‚â”€â”€â”€â”€â”¤    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
                                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
   Smart TV â”€â”€â”€â”€â”€â”€â”€>â”‚    TV BFF       â”‚â”€â”€â”€â”€â”˜
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Æ¯u Ä‘iá»ƒm BFF:**
- Tá»‘i Æ°u response cho tá»«ng loáº¡i client
- Mobile nháº­n data nháº¹ hÆ¡n Web
- Dá»… evolve Ä‘á»™c láº­p

### Xá»­ lÃ½ lá»—i trong Aggregation

| Chiáº¿n lÆ°á»£c | MÃ´ táº£ | Use Case |
|------------|-------|----------|
| **Fail Fast** | Náº¿u 1 service lá»—i â†’ tráº£ vá» lá»—i ngay | Data báº¯t buá»™c pháº£i cÃ³ Ä‘áº§y Ä‘á»§ |
| **Partial Response** | Tráº£ vá» data cÃ³ Ä‘Æ°á»£c, bá» qua service lá»—i | Data khÃ´ng critical |
| **Fallback** | DÃ¹ng cached data hoáº·c default value khi service lá»—i | UX quan trá»ng |

**VÃ­ dá»¥ Partial Response:**
```json
{
  "user": { "id": 123, "name": "Nguyen Van A" },
  "recentOrders": null,
  "errors": [
    {
      "service": "order-service",
      "message": "Service temporarily unavailable"
    }
  ]
}
```

---

## 10. Protocol Translation

### Protocol Translation lÃ  gÃ¬?

**Protocol Translation** lÃ  kháº£ nÄƒng cá»§a API Gateway chuyá»ƒn Ä‘á»•i giá»¯a cÃ¡c giao thá»©c khÃ¡c nhau, cho phÃ©p client vÃ  backend services giao tiáº¿p dÃ¹ sá»­ dá»¥ng cÃ¡c protocol khÃ¡c nhau.

### Táº¡i sao cáº§n Protocol Translation?

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        THá»°C Táº¾                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Mobile app muá»‘n dÃ¹ng REST (Ä‘Æ¡n giáº£n, phá»• biáº¿n)                   â”‚
â”‚  â€¢ Internal services dÃ¹ng gRPC (hiá»‡u nÄƒng cao)                      â”‚
â”‚  â€¢ Legacy system dÃ¹ng SOAP (há»‡ thá»‘ng cÅ©)                            â”‚
â”‚  â€¢ Real-time features cáº§n WebSocket                                 â”‚
â”‚  â€¢ IoT devices dÃ¹ng MQTT (lightweight)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
              API Gateway giáº£i quyáº¿t váº¥n Ä‘á» nÃ y
              báº±ng Protocol Translation
```

### CÃ¡c loáº¡i Protocol Translation phá»• biáº¿n

#### 10.1 REST â†” gRPC

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   HTTP/REST    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    gRPC     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ API Gateway â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ gRPC Serviceâ”‚
â”‚ (Mobile) â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚             â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   JSON         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  Protobuf   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**VÃ­ dá»¥ chuyá»ƒn Ä‘á»•i:**

REST Request:
```http
POST /api/users
Content-Type: application/json

{
  "name": "Nguyen Van A",
  "email": "a@example.com"
}
```

Chuyá»ƒn thÃ nh gRPC call:
```protobuf
service UserService {
  rpc CreateUser(CreateUserRequest) returns (User);
}

message CreateUserRequest {
  string name = 1;
  string email = 2;
}
```

#### 10.2 REST to REST - URL Rewriting & Path Translation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   External API   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  Internal API  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ API Gateway â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚   Identity   â”‚
â”‚          â”‚  /api/v1/identifyâ”‚             â”‚ /auth/login    â”‚   Service    â”‚
â”‚          â”‚                  â”‚   Rewrite   â”‚                â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**VÃ­ dá»¥:**

Client Request (External):
```http
POST api/v1/identtify/auth/login
Host: api.cathay.com
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "secret123"
}
```

Gateway Rewrites to (Internal):
```http
POST /autg/login
Host: identity-service:8081
Content-Type: application/json
X-Gateway-Id: gateway-001
X-Request-Id: abc-123-def

{
  "email": "user@example.com",
  "password": "secret123"
}
```

**Lá»£i Ã­ch:**
- âœ… Che giáº¥u cáº¥u trÃºc internal service
- âœ… Versioning linh hoáº¡t (external `/api/v1/identify/auth/login` â†’ internal `/auth/login`)
- âœ… ThÃªm headers tracking (X-Request-Id, X-Gateway-Id)

#### 10.3 REST to REST - Request/Response Transformation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   Simple API     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  Detailed API  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Mobile  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ API Gateway â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚   Payment    â”‚
â”‚  Client  â”‚  Minimal data    â”‚             â”‚  Full payload  â”‚   Service    â”‚
â”‚          â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  Transform  â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   Simplified     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   Complete     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**VÃ­ dá»¥:**

Mobile Client Request (Simplified):
```http
POST /payment/transfer
{
  "to": "123456789",
  "amount": 1000000
}
```

Gateway Transforms to Internal Service:
```http
POST /api/v1/payment/transfer
{
  "from_account_id": "user-uuid-from-jwt",
  "to_account_number": "123456789",
  "amount": 1000000,
  "currency": "VND",
  "transaction_type": "INTERNAL_TRANSFER",
  "metadata": {
    "source": "mobile_app",
    "device_id": "device-123",
    "ip_address": "192.168.1.1",
    "timestamp": "2026-01-29T10:00:00Z"
  }
}
```

Internal Service Response:
```json
{
  "transaction_id": "txn-abc-123",
  "status": "SUCCESS",
  "from_account": {
    "id": "user-uuid",
    "number": "987654321",
    "balance": 5000000
  },
  "to_account": {
    "id": "recipient-uuid",
    "number": "123456789"
  },
  "amount": 1000000,
  "fee": 0,
  "created_at": "2026-01-29T10:00:01Z",
  "processed_at": "2026-01-29T10:00:02Z"
}
```

Gateway Transforms to Mobile Client (Simplified):
```json
{
  "success": true,
  "transaction_id": "txn-abc-123",
  "new_balance": 5000000
}
```

**Lá»£i Ã­ch:**
- âœ… Mobile client nháº­n data tá»‘i giáº£n â†’ tiáº¿t kiá»‡m bandwidth
- âœ… Gateway enrichment: thÃªm metadata tá»« JWT, request context
- âœ… Response filtering: chá»‰ tráº£ vá» fields cáº§n thiáº¿t

#### 10.4 External â†” Internal Protocol

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         API GATEWAY                                â”‚
â”‚                                                                    â”‚
â”‚   External (Public)          â”‚         Internal (Private)          â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚
â”‚   â€¢ HTTPS (secure)           â”‚         â€¢ HTTP (faster)             â”‚
â”‚   â€¢ REST/JSON                â”‚         â€¢ gRPC/Protobuf             â”‚
â”‚   â€¢ Rate limited             â”‚         â€¢ No rate limit             â”‚
â”‚   â€¢ Authentication required  â”‚         â€¢ Internal auth             â”‚
â”‚                              â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### So sÃ¡nh cÃ¡c Protocol

| Protocol | Format | Use Case | Æ¯u Ä‘iá»ƒm | NhÆ°á»£c Ä‘iá»ƒm |
|----------|--------|----------|---------|------------|
| **REST** | JSON | Web/Mobile APIs | ÄÆ¡n giáº£n, phá»• biáº¿n | Overhead vá»›i JSON |
| **gRPC** | Protobuf | Service-to-service | Hiá»‡u nÄƒng cao, strongly typed | Phá»©c táº¡p hÆ¡n REST |
| **GraphQL** | JSON | Flexible queries | Client quyáº¿t Ä‘á»‹nh data cáº§n | Complexity, caching khÃ³ |
| **SOAP** | XML | Enterprise/Legacy | Mature, WS-Security | Verbose, heavy |
| **WebSocket** | Any | Real-time | Bidirectional, low latency | Stateful, scaling khÃ³ |


### Lá»£i Ã­ch cá»§a Protocol Translation

| Lá»£i Ã­ch | MÃ´ táº£ |
|---------|-------|
| **Decouple client tá»« backend** | Client khÃ´ng cáº§n biáº¿t backend dÃ¹ng protocol gÃ¬ |
| **Legacy integration** | Káº¿t ná»‘i há»‡ thá»‘ng cÅ© (SOAP) vá»›i modern clients |
| **Performance optimization** | DÃ¹ng gRPC internally, REST externally |
| **Gradual migration** | Migrate tá»« SOAP sang REST |
| **Flexibility** | Thay Ä‘á»•i internal protocol khÃ´ng áº£nh hÆ°á»Ÿng client |

---

## Tá»•ng káº¿t

```
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚              API GATEWAY                  â”‚
                         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
   Client Request â”€â”€â”€â”€â”€â”€>â”‚  â”‚        Security Layer               â”‚  â”‚
   (REST/GraphQL)        â”‚  â”‚  â€¢ SSL/TLS Termination              â”‚  â”‚
                         â”‚  â”‚  â€¢ Authentication (JWT)             â”‚  â”‚
                         â”‚  â”‚  â€¢ Authorization (RBAC)             â”‚  â”‚
                         â”‚  â”‚  â€¢ CORS                             â”‚  â”‚
                         â”‚  â”‚  â€¢ DDoS Protection                  â”‚  â”‚
                         â”‚  â”‚  â€¢ Rate Limiting                    â”‚  â”‚
                         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                         â”‚                    â”‚                      â”‚
                         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                         â”‚  â”‚        Traffic Management           â”‚  â”‚
                         â”‚  â”‚  â€¢ Routing                          â”‚  â”‚
                         â”‚  â”‚  â€¢ Load Balancing                   â”‚  â”‚
                         â”‚  â”‚  â€¢ Protocol Translation             â”‚  â”‚
                         â”‚  â”‚  â€¢ API Aggregation                  â”‚  â”‚
                         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                         â”‚                    â”‚                      â”‚
                         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                         â”‚  â”‚        Observability                â”‚  â”‚
                         â”‚  â”‚  â€¢ Logging                          â”‚  â”‚
                         â”‚  â”‚  â€¢ Metrics                          â”‚  â”‚
                         â”‚  â”‚  â€¢ Distributed Tracing              â”‚  â”‚
                         â”‚  â”‚  â€¢ Health Checks                    â”‚  â”‚
                         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                         â”‚                         â”‚
                    â–¼                         â–¼                         â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Service A   â”‚           â”‚ Service B   â”‚           â”‚ Service C   â”‚
              â”‚ (gRPC)      â”‚           â”‚ (REST)      â”‚           â”‚ (SOAP)      â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

*TÃ i liá»‡u Ä‘Æ°á»£c táº¡o cho Cathay OJT Program*
